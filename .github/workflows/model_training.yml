name: Daily Model Training

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  train-models:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Defaults to empty to satisfy schema/linting; provide real values via
      # GitHub Repo Variables or by exporting in a prior step/runner context.
      DATABASE_URL: ""
      DB_HOST: ""
      DB_PORT: ""
      DB_NAME: ""
      DB_USER: ""
      DB_PASSWORD: ""
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify repository files
        run: |
          echo "Listing models directory" && ls -la models || true
          if [ ! -f "models/train_all_models.py" ]; then
            echo "Expected file models/train_all_models.py not found. Ensure latest commits are pushed." >&2
            exit 1
          fi

      - name: Verify DB config (skip if missing)
        run: |
          if [ -z "${DATABASE_URL}${DB_HOST}${DB_NAME}${DB_USER}${DB_PASSWORD}" ]; then
            echo "No DB configuration found in environment."
            echo "Set DATABASE_URL or DB_HOST/DB_NAME/DB_USER/DB_PASSWORD as Repo Variables or inject at runtime."
          else
            echo "DB configuration detected. Proceeding to training."
          fi

      - name: Train ML models
        if: env.DATABASE_URL != '' || (env.DB_HOST != '' && env.DB_NAME != '' && env.DB_USER != '' && env.DB_PASSWORD != '')
        run: |
          python models/train_all_models.py --all

      - name: Upload training summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-summary
          path: |
            models/trained_models/training_summary.json
          if-no-files-found: warn

      - name: Upload trained model artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: models/trained_models
          if-no-files-found: warn
      
      - name: Report status
        if: always()
        run: |
          echo "Model training completed at $(date)"
          echo "Status: ${{ job.status }}"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "⚠️ Model training failed!"
          echo "Check the logs for details"
